{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <!-- 拖拽区域 -->
    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 mb-6 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50/30 cursor-pointer group">
        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
            <svg class="icon text-white text-2xl" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/>
                <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">拖拽文件到此处上传</h3>
        <p class="text-gray-500 text-sm">支持文本、图片和任意文件类型 • 支持批量上传</p>
        <!-- <p class="text-gray-500 text-sm mb-6">支持文本、图片和任意文件类型 • 支持批量上传</p> -->
        <!-- <button class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 shadow-lg"> -->
        <!--     <i class="fa fa-folder-open mr-2"></i>选择文件 -->
        <!-- </button> -->
    </div>

    <h2 class="text-xl font-bold mb-4">剪贴板历史记录</h2>

    <!-- 粘贴和拖拽提示 -->
    <!-- <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-xl p-4 mb-6 shadow-sm"> -->
    <!--     <div class="flex items-center justify-between"> -->
    <!--         <div class="flex items-center space-x-3"> -->
    <!--             <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center"> -->
    <!--                 <i class="fa fa-info text-white"></i> -->
    <!--             </div> -->
    <!--             <div> -->
    <!--                 <p class="text-sm text-gray-700"> -->
    <!--                     <kbd class="px-2 py-1 bg-white rounded text-xs font-mono shadow-sm border border-gray-200">Ctrl+V</kbd> -->
    <!--                     <span class="mx-2 text-gray-400">|</span> -->
    <!--                     粘贴内容 -->
    <!--                     <span class="mx-2 text-gray-400">|</span> -->
    <!--                     <kbd class="px-2 py-1 bg-white rounded text-xs font-mono shadow-sm border border-gray-200">拖拽</kbd> -->
    <!--                     <span class="mx-2 text-gray-400">|</span> -->
    <!--                     上传文件 -->
    <!--                     <span class="mx-2 text-gray-400">|</span> -->
    <!--                     <kbd class="px-2 py-1 bg-white rounded text-xs font-mono shadow-sm border border-gray-200">Ctrl+点击图片</kbd> -->
    <!--                     <span class="mx-2 text-gray-400">|</span> -->
    <!--                     快速复制 -->
    <!--                 </p> -->
    <!--             </div> -->
    <!--         </div> -->
    <!--     </div> -->
    <!-- </div> -->

    <!-- 隐藏的文件输入元素 -->
    <input type="file" id="file-input" multiple class="hidden" accept="*/*">

    <!-- 筛选器 -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <!-- 筛选按钮组 -->
        <div class="flex flex-wrap gap-2">
            <button type="button" class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="all">
                <svg class="icon" viewBox="0 0 16 16">
                    <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/>
                </svg>
                <span>全部类型</span>
            </button>
            <button type="button" class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="Text">
                <svg class="icon text-blue-500" viewBox="0 0 16 16">
                    <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                    <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/>
                </svg>
                <span>文本</span>
            </button>
            <button type="button" class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="Image">
                <svg class="icon text-green-500" viewBox="0 0 16 16">
                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                </svg>
                <span>图片</span>
            </button>
            <button type="button" class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="File">
                <svg class="icon text-purple-500" viewBox="0 0 16 16">
                    <path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>
                </svg>
                <span>文件</span>
            </button>
        </div>
    </div>

    <!-- 历史记录列表容器 -->
    <div id="history-list" class="space-y-4">
        <!-- 加载提示 -->
        <div class="bg-white rounded-lg shadow-sm p-8 text-center">
            <svg class="icon icon-spin text-primary text-3xl mb-4" viewBox="0 0 16 16">
                <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
            </svg>
            <p class="text-gray-500">加载历史记录中...</p>
        </div>
    </div>

    <!-- 分页控件 -->
    <div id="pagination" class="mt-6 flex justify-center items-center gap-2 hidden">
        <button id="prev-page" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
            <svg class="icon mr-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
            </svg>
            上一页
        </button>
        <span class="text-gray-600">
            第 <span id="current-page">1</span> 页 / 共 <span id="total-pages">0</span> 页
        </span>
        <button id="next-page" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
            下一页
            <svg class="icon ml-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
            </svg>
        </button>
    </div>
</div>

<!-- 图片预览模态框 -->
<div id="image-modal" class="fixed inset-0 bg-black z-50 hidden">
    <!-- 顶部控制栏 -->
    <div class="absolute top-0 left-0 right-0 bg-black/50 text-white p-4 z-10">
        <div class="flex justify-between items-center">
            <h3 id="modal-title" class="font-medium truncate max-w-md"></h3>
            <div class="flex items-center space-x-4">
                <button id="modal-copy-image" class="text-white hover:text-blue-300 transition-colors px-3 py-2 rounded-lg hover:bg-white/10">
                    <svg class="icon" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M4 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
                        <path d="M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                </button>
                <button id="close-modal" class="text-white hover:text-gray-300 transition-colors px-3 py-2 rounded-lg hover:bg-white/10">
                    <svg class="icon text-lg" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <!-- 图片容器 -->
    <div class="w-full h-full flex items-center justify-center p-4">
        <img id="modal-image" src="" alt="图片预览" class="max-w-full max-h-full object-contain">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const PAGE_SIZE = 30;
    let currentOffset = 0;
    let totalRecords = 0;

    // 页面加载后初始化
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        initPaginationEvents();
        initModalEvents();
        initPasteEvents();
        initDragAndDropEvents();
        initFilterEvents();
        initSearchEvents();
    });

    // 初始化模态框事件
    function initModalEvents() {
        const modal = document.getElementById('image-modal');
        const closeBtn = document.getElementById('close-modal');
        const copyBtn = document.getElementById('modal-copy-image');
        const modalImg = document.getElementById('modal-image');
        let currentImageChecksum = null;

        // 点击关闭按钮关闭模态框
        closeBtn.addEventListener('click', () => {
            closeModal();
        });

        // 点击复制按钮复制图片
        copyBtn.addEventListener('click', () => {
            if (currentImageChecksum) {
                copyImageToClipboard(currentImageChecksum, copyBtn);
            }
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // 点击模态框外部关闭（点击背景黑色区域）
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // 点击图片也能关闭模态框
        modalImg.addEventListener('click', () => {
            closeModal();
        });

        // 存储当前图片的checksum供复制使用
        window.updateModalImageChecksum = function(checksum) {
            currentImageChecksum = checksum;
        };

        // 关闭模态框的函数
        function closeModal() {
            modal.classList.add('hidden');
            // 清空图片src以释放内存
            modalImg.src = '';
        }
    }

    // 初始化粘贴事件
    function initPasteEvents() {
        document.addEventListener('paste', handlePaste);
    }

    // 初始化拖拽事件
    function initDragAndDropEvents() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        // 防止浏览器默认行为
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        // 高亮拖拽区域
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        // 处理拖拽的文件
        dropZone.addEventListener('drop', handleDrop, false);

        // 点击拖拽区域触发文件选择
        dropZone.addEventListener('click', function(e) {
            // 防止按钮点击时重复触发
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                e.preventDefault();
            }
            fileInput.click();
        });

        // 处理文件选择
        fileInput.addEventListener('change', handleFileSelect, false);
    }

    // 阻止默认行为
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // 高亮拖拽区域
    function highlight(e) {
        document.getElementById('drop-zone').classList.add('border-blue-500', 'bg-blue-50');
        document.getElementById('drop-zone').classList.remove('border-gray-300');
    }

    // 取消高亮
    function unhighlight(e) {
        document.getElementById('drop-zone').classList.remove('border-blue-500', 'bg-blue-50');
        document.getElementById('drop-zone').classList.add('border-gray-300');
    }

    // 处理拖拽的文件
    async function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            // 处理所有拖拽的文件
            for (let file of files) {
                await handleDroppedFile(file);
            }
        }
    }

    // 处理选择的文件
    async function handleFileSelect(e) {
        const files = e.target.files;

        if (files.length > 0) {
            // 处理所有选择的文件
            for (let file of files) {
                await handleDroppedFile(file);
            }
        }

        // 清空input，允许重复选择同一文件
        e.target.value = '';
    }

    // 处理单个拖拽的文件
    async function handleDroppedFile(file) {
        // 显示处理中提示
        showDropProcessing(file.name);

        try {
            if (file.type.startsWith('image/')) {
                // 处理图片文件
                await handleImageDrop(file);
            } else if (file.type.startsWith('text/')) {
                // 处理文本文件
                await handleTextFileDrop(file);
            } else {
                // 处理其他文件类型
                await handleFileDrop(file);
            }
        } catch (error) {
            console.error('文件拖拽错误:', error);
            showNotification(`处理文件 ${file.name} 失败: ${error.message}`, 'error');
        } finally {
            hideDropProcessing();
        }
    }

    // 处理图片文件拖拽
    async function handleImageDrop(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'Image');

        const response = await fetch('/api/paste/image', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            showNotification(`图片 ${file.name} 已添加到剪贴板历史`, 'success');
            // 刷新历史记录，显示最新内容
            currentOffset = 0;
            loadHistory();
        } else {
            showNotification(`添加图片失败: ${result.error}`, 'error');
        }
    }

    // 处理文本文件拖拽
    async function handleTextFileDrop(file) {
        try {
            const text = await file.text();
            await handleTextPaste(text);
            showNotification(`文本文件 ${file.name} 内容已添加到剪贴板历史`, 'success');
        } catch (error) {
            showNotification(`读取文本文件 ${file.name} 失败`, 'error');
        }
    }

    // 处理其他文件类型拖拽
    async function handleFileDrop(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'File');

        const response = await fetch('/api/paste/file', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            showNotification(`文件 ${file.name} 已添加到剪贴板历史`, 'success');
            // 刷新历史记录，显示最新内容
            currentOffset = 0;
            loadHistory();
        } else {
            showNotification(`添加文件失败: ${result.error}`, 'error');
        }
    }

    // 显示拖拽处理中状态
    function showDropProcessing(fileName) {
        const processingDiv = document.createElement('div');
        processingDiv.id = 'drop-processing';
        processingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        processingDiv.innerHTML = `<svg class="icon icon-spin mr-2" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/></svg>正在处理文件: ${fileName}`;
        document.body.appendChild(processingDiv);
    }

    // 隐藏拖拽处理中状态
    function hideDropProcessing() {
        const processingDiv = document.getElementById('drop-processing');
        if (processingDiv) {
            processingDiv.remove();
        }
    }

    // 初始化筛选事件
    function initFilterEvents() {
        const filterButtons = document.querySelectorAll('.filter-toggle');
        let currentFilter = 'all'; // 默认显示全部类型
        let allRecords = []; // 存储所有记录

        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filterType = this.getAttribute('data-type');

                // 更新按钮状态
                filterButtons.forEach(btn => {
                    btn.classList.remove('bg-primary/10', 'text-primary');
                });
                this.classList.add('bg-primary/10', 'text-primary');

                currentFilter = filterType;

                // 筛选并重新渲染记录
                filterAndRenderRecords(filterType);
            });
        });

        // 将筛选后的记录渲染函数暴露给全局
        window.filterAndRenderRecords = function(filterType) {
            const container = document.getElementById('history-list');
            const records = container.querySelectorAll('.bg-white.rounded-lg.shadow-sm');

            records.forEach(record => {
                const recordType = record.querySelector('.text-sm.font-medium.text-gray-900')?.textContent;

                if (filterType === 'all') {
                    record.style.display = 'block';
                } else {
                    record.style.display = recordType === filterType ? 'block' : 'none';
                }
            });

            // 更新显示的记录数量
            const visibleRecords = Array.from(records).filter(record => record.style.display !== 'none');
            updateVisibleCount(visibleRecords.length);
        };

        // 更新可见记录数量
        window.updateVisibleCount = function(count) {
            // 可以在这里添加显示记录数量的逻辑
            console.log(`显示 ${count} 条记录`);
        };
    }

    // 处理粘贴事件
    async function handlePaste(e) {
        e.preventDefault();

        const items = e.clipboardData.items;
        let processed = false;

        // 显示处理中提示
        showPasteProcessing();

        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                // 处理图片粘贴
                const blob = item.getAsFile();
                await handleImagePaste(blob);
                processed = true;
                break;
            } else if (item.type === 'text/plain') {
                // 处理文本粘贴
                const text = e.clipboardData.getData('text/plain');
                await handleTextPaste(text);
                processed = true;
                break;
            } else if (item.kind === 'file') {
                // 处理文件粘贴
                const file = item.getAsFile();
                await handleFilePaste(file);
                processed = true;
                break;
            }
        }

        if (!processed) {
            hidePasteProcessing();
            showNotification('不支持的粘贴内容类型', 'error');
        }
    }

    // 处理文本粘贴
    async function handleTextPaste(text) {
        try {
            const response = await fetch('/api/paste/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: text,
                    type: 'Text'
                })
            });

            const result = await response.json();
            if (result.success) {
                showNotification('文本已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('文本粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 处理图片粘贴
    async function handleImagePaste(blob) {
        try {
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('type', 'Image');

            const response = await fetch('/api/paste/image', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showNotification('图片已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('图片粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 处理文件粘贴
    async function handleFilePaste(file) {
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', 'File');

            const response = await fetch('/api/paste/file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showNotification('文件已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('文件粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 显示粘贴处理中状态
    function showPasteProcessing() {
        const processingDiv = document.createElement('div');
        processingDiv.id = 'paste-processing';
        processingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        processingDiv.innerHTML = '<svg class="icon icon-spin mr-2" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/></svg>正在处理粘贴内容...';
        document.body.appendChild(processingDiv);
    }

    // 隐藏粘贴处理中状态
    function hidePasteProcessing() {
        const processingDiv = document.getElementById('paste-processing');
        if (processingDiv) {
            processingDiv.remove();
        }
    }

    // 显示删除确认对话框
    async function confirmDelete() {
        return new Promise((resolve) => {
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md mx-4 shadow-2xl">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mr-4">
                            <svg class="icon text-red-500 text-xl" viewBox="0 0 16 16">
                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
                            <p class="text-sm text-gray-600">此操作无法撤销，确定要删除这条记录吗？</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="cancel-btn px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            取消
                        </button>
                        <button type="button" class="confirm-btn px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            确认删除
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // 绑定事件
            const cancelBtn = modal.querySelector('.cancel-btn');
            const confirmBtn = modal.querySelector('.confirm-btn');

            cancelBtn.addEventListener('click', () => {
                modal.remove();
                resolve(false);
            });

            confirmBtn.addEventListener('click', () => {
                modal.remove();
                resolve(true);
            });

            // ESC键取消
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEscape);
                    resolve(false);
                }
            };
            document.addEventListener('keydown', handleEscape);
        });
    }

    // 删除记录
    async function deleteRecord(uuid, cardElement) {
        try {
            // 显示删除中状态
            const originalOpacity = cardElement.style.opacity;
            cardElement.style.opacity = '0.5';
            cardElement.style.pointerEvents = 'none';

            const response = await fetch(`/api/delete/${uuid}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                // 移除卡片动画
                cardElement.style.transform = 'translateX(100%)';
                cardElement.style.opacity = '0';
                cardElement.style.transition = 'all 0.3s ease-out';

                setTimeout(() => {
                    cardElement.remove();

                    // 更新总记录数
                    totalRecords = Math.max(0, totalRecords - 1);
                    updatePaginationUI();

                    showNotification('记录已删除', 'success');
                }, 300);
            } else {
                // 恢复卡片状态
                cardElement.style.opacity = originalOpacity;
                cardElement.style.pointerEvents = 'auto';
                showNotification('删除失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('删除记录错误:', error);
            cardElement.style.opacity = originalOpacity;
            cardElement.style.pointerEvents = 'auto';
            showNotification('删除失败', 'error');
        }
    }

    // 初始化搜索事件
    function initSearchEvents() {
        const searchInput = document.getElementById('search-input');
        const clearBtn = document.getElementById('clear-search');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const clearBtnMobile = document.getElementById('clear-search-mobile');

        let searchTimeout;

        // 搜索函数
        function performSearch(query) {
            clearTimeout(searchTimeout);

            if (query.trim()) {
                // 显示清除按钮
                if (clearBtn) clearBtn.classList.remove('hidden');
                if (clearBtnMobile) clearBtnMobile.classList.remove('hidden');

                // 延迟搜索，避免频繁请求
                searchTimeout = setTimeout(() => {
                    searchRecords(query);
                }, 300);
            } else {
                // 隐藏清除按钮
                if (clearBtn) clearBtn.classList.add('hidden');
                if (clearBtnMobile) clearBtnMobile.classList.add('hidden');

                // 清空搜索，显示所有记录
                loadHistory();
            }
        }

        // 桌面端搜索事件
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                performSearch(e.target.value);

                // 同步移动端搜索框
                if (searchInputMobile) {
                    searchInputMobile.value = e.target.value;
                }
            });
        }

        // 移动端搜索事件
        if (searchInputMobile) {
            searchInputMobile.addEventListener('input', (e) => {
                performSearch(e.target.value);

                // 同步桌面端搜索框
                if (searchInput) {
                    searchInput.value = e.target.value;
                }
            });
        }

        // 清除按钮事件
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                if (searchInputMobile) searchInputMobile.value = '';
                clearBtn.classList.add('hidden');
                if (clearBtnMobile) clearBtnMobile.classList.add('hidden');
                loadHistory();
            });
        }

        if (clearBtnMobile) {
            clearBtnMobile.addEventListener('click', () => {
                searchInputMobile.value = '';
                if (searchInput) searchInput.value = '';
                clearBtnMobile.classList.add('hidden');
                if (clearBtn) clearBtn.classList.add('hidden');
                loadHistory();
            });
        }
    }

    // 搜索记录
    async function searchRecords(query) {
        const container = document.getElementById('history-list');

        // 显示加载中状态
        container.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                <svg class="icon icon-spin text-primary text-3xl mb-4" viewBox="0 0 16 16">
                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                    <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                </svg>
                <p class="text-gray-500">搜索中...</p>
            </div>
        `;

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=${PAGE_SIZE}&offset=0`);
            const data = await response.json();

            if (data.success) {
                totalRecords = data.data.total;
                currentOffset = 0;
                renderRecords(data.data.records);
                updatePaginationUI();

                // 显示搜索结果信息
                if (data.query && data.data.total > 0) {
                    showNotification(`找到 ${data.data.total} 条相关记录`, 'success');
                } else if (data.query && data.data.total === 0) {
                    showNotification('未找到相关记录', 'info');
                }
            } else {
                container.innerHTML = `<div class="text-center text-red-500">搜索失败: ${data.error}</div>`;
            }
        } catch (error) {
            console.error('搜索错误:', error);
            container.innerHTML = `<div class="text-center text-red-500">搜索失败</div>`;
        }
    }

    // 显示通知
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-gray-500 text-white'
        }`;
        notification.innerHTML = message;
        document.body.appendChild(notification);

        // 3秒后自动移除
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // 复制图片到剪贴板
    async function copyImageToClipboard(checksum, buttonElement) {
        console.log('开始复制图片，checksum:', checksum, '按钮:', buttonElement);

        try {
            if (!checksum) {
                throw new Error('图片checksum为空');
            }

            // 获取图片数据
            const response = await fetch(`/api/download?checksum=${checksum}`);
            if (!response.ok) {
                throw new Error('获取图片失败: ' + response.statusText);
            }

            const blob = await response.blob();
            console.log('获取图片blob成功，类型:', blob.type, '大小:', blob.size);

            // 检查是否支持Clipboard API
            if (navigator.clipboard && navigator.clipboard.write) {
                console.log('浏览器支持Clipboard API，开始复制...');
                // 创建ClipboardItem对象
                const clipboardItem = new ClipboardItem({
                    [blob.type]: blob
                });

                // 写入剪贴板
                await navigator.clipboard.write([clipboardItem]);
                console.log('复制到剪贴板成功');

                // 如果有按钮元素，显示成功状态
                if (buttonElement) {
                    const svg = buttonElement.querySelector('svg');
                    const originalHtml = svg.innerHTML;
                    buttonElement.classList.remove('text-green-500', 'hover:text-green-700', 'hover:bg-green-50');
                    buttonElement.classList.add('text-green-600', 'bg-green-50');
                    svg.innerHTML = '<path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>';

                    setTimeout(() => {
                        if (buttonElement && svg) {
                            buttonElement.classList.remove('text-green-600', 'bg-green-50');
                            buttonElement.classList.add('text-green-500', 'hover:text-green-700', 'hover:bg-green-50');
                            svg.innerHTML = originalHtml;
                        }
                    }, 2000);
                }

                showNotification('图片已复制到剪贴板', 'success');
            } else {
                // 浏览器不支持Clipboard API，提示用户使用下载
                console.log('浏览器不支持Clipboard API');
                showNotification('您的浏览器不支持直接复制图片，请使用下载功能', 'error');
            }

        } catch (error) {
            console.error('复制图片失败:', error);
            showNotification('复制图片失败: ' + error.message, 'error');
        }
    }

    // 加载历史记录
    function loadHistory() {
        const container = document.getElementById('history-list');
        container.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                <svg class="icon icon-spin text-primary text-3xl mb-4" viewBox="0 0 16 16">
                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                    <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                </svg>
                <p class="text-gray-500">加载历史记录中...</p>
            </div>
        `; // 显示加载中

        fetch(`/api/history?limit=${PAGE_SIZE}&offset=${currentOffset}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    totalRecords = data.data.total;
                    renderRecords(data.data.records);
                    updatePaginationUI();
                } else {
                    container.innerHTML = `<div class="text-center text-red-500">加载失败: ${data.error}</div>`;
                }
            });
    }

    // 获取类型对应的图标
    function getTypeIcon(type) {
        const iconMap = {
            'Text': {
                svg: '<path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/>',
                color: 'text-blue-500',
                bgColor: 'bg-blue-100'
            },
            'Image': {
                svg: '<path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>',
                color: 'text-green-500',
                bgColor: 'bg-green-100'
            },
            'File': {
                svg: '<path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>',
                color: 'text-purple-500',
                bgColor: 'bg-purple-100'
            }
        };

        const typeInfo = iconMap[type] || iconMap['File'];
        return typeInfo;
    }

    // 渲染记录列表
    function renderRecords(records) {
        const container = document.getElementById('history-list');
        if (records.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                    <p class="text-gray-500">暂无历史记录</p>
                </div>
            `;
            return;
        }

        let html = '';
        records.forEach(record => {
            // 获取类型图标信息
            const typeIcon = getTypeIcon(record.type);

            // 根据类型生成不同的内容预览
            let previewContent = '';
            let actionButton = '';
            let extraInfo = '';

            if (record.type === 'Text') {
                // 文本类型：显示内容预览和复制按钮
                const maxLength = 100;
                const content = record.content || '';
                const isLongText = content.length > maxLength;
                const preview = isLongText
                    ? content.substring(0, maxLength) + '...'
                    : content;

                // 构建预览内容（带展开/折叠功能）
                previewContent = `
                    <div class="text-content-container">
                        <div class="text-preview bg-gradient-to-br from-gray-50 to-blue-50/30 rounded-xl p-4 border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-2 right-2 text-xs text-gray-400 bg-white/80 px-2 py-1 rounded-full">
                                ${content.length} 字符
                            </div>
                            <div class="${isLongText ? 'preview-text' : ''} text-gray-700 leading-relaxed">
                                ${formatTextDisplay(isLongText ? preview : content)}
                            </div>
                            ${isLongText ? `
                                <div class="full-text hidden text-gray-700 leading-relaxed">
                                    ${formatTextDisplay(content)}
                                </div>
                            ` : ''}
                        </div>
                        ${isLongText ? `
                            <button type="button" class="toggle-text flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-700 mt-3 font-medium transition-colors duration-200 group">
                                <svg class="icon transition-transform duration-200" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                </svg>
                                <span class="toggle-text-label">展开完整内容</span>
                            </button>
                        ` : ''}
                    </div>
                `;

                actionButton = `
                    <div class="flex items-center space-x-1">
                        <button type="button" class="copy-btn text-blue-500 hover:text-blue-700 hover:bg-blue-50 w-8 h-8 rounded-lg transition-all duration-200 flex items-center justify-center" data-clipboard="${escapeAttr(content)}" title="复制文本">
                            <svg class="icon" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                        </button>
                        <button type="button" class="delete-btn text-red-500 hover:text-red-700 hover:bg-red-50 w-8 h-8 rounded-lg transition-all duration-200 flex items-center justify-center" data-uuid="${record.uuid}" title="删除记录">
                            <svg class="icon" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                        </button>
                    </div>
                `;
            }
            else if (record.type === 'Image') {
                // 图片类型：显示缩略图和复制按钮
                const fileName = record.file_name || '未知图片';

                previewContent = `
                    <div class="mt-2">
                        <div class="relative inline-block group">
                            <img src="/api/download?checksum=${record.checksum}"
                                 alt="${escapeHtml(fileName)}"
                                 class="max-h-36 max-w-full rounded-lg border border-gray-200 cursor-pointer preview-img hover:border-blue-400 hover:shadow-md transition-all duration-200"
                                 data-filename="${escapeHtml(fileName)}"
                                 data-src="/api/download?checksum=${record.checksum}"
                                 data-checksum="${record.checksum}">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 rounded-lg transition-all duration-200 pointer-events-none"></div>
                            <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <svg class="icon" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                </svg>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 font-medium">${escapeHtml(fileName)}</p>
                    </div>
                `;

                actionButton = `
                    <div class="flex items-center space-x-1">
                        <button type="button" class="copy-image-btn text-green-500 hover:text-green-700 hover:bg-green-50 w-8 h-8 rounded-lg transition-all duration-200 flex items-center justify-center" data-checksum="${record.checksum}" title="复制图片">
                            <svg class="icon" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M4 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/>
                                <path d="M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                        <a href="/api/download?checksum=${record.checksum}" class="text-purple-500 hover:text-purple-700 hover:bg-purple-50 w-8 h-8 rounded-lg transition-all duration-200 flex items-center justify-center" download title="下载图片">
                            <svg class="icon" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                        </a>
                        <button type="button" class="delete-btn text-red-500 hover:text-red-700 hover:bg-red-50 w-8 h-8 rounded-lg transition-all duration-200 flex items-center justify-center" data-uuid="${record.uuid}" title="删除记录">
                            <svg class="icon" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                        </button>
                    </div>
                `;
            }
            else if (record.type === 'File' || record.type === 'Group') {
                // 文件类型：显示文件名和下载按钮
                const fileName = record.file_name || '未知文件';

                // 获取文件大小信息（这里假设后端会返回，如果没有可以去掉）
                if (record.size) {
                    extraInfo = `<div class="text-xs text-gray-400 mt-1">
                        文件大小: ${formatFileSize(record.size)}
                    </div>`;
                }

                previewContent = `
                    <div class="flex items-center space-x-2 bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center">
                            <svg class="icon text-gray-500" viewBox="0 0 16 16">
                                <path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2l-3-3z"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-700 truncate font-medium">${escapeHtml(fileName)}</p>
                            ${extraInfo ? `<div class="text-xs text-gray-500 mt-1">${extraInfo}</div>` : ''}
                        </div>
                    </div>
                `;

                actionButton = `
                    <div class="flex items-center space-x-1">
                        <a href="/api/download?checksum=${record.checksum}" class="text-purple-500 hover:text-purple-700 hover:bg-purple-50 w-8 h-8 rounded-lg transition-all duration-200 flex items-center justify-center" download title="下载文件">
                            <svg class="icon" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                        </a>
                        <button type="button" class="delete-btn text-red-500 hover:text-red-700 hover:bg-red-50 w-8 h-8 rounded-lg transition-all duration-200 flex items-center justify-center" data-uuid="${record.uuid}" title="删除记录">
                            <svg class="icon" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                        </button>
                    </div>
                `;
            }

            // 来源和标签信息
            let sourceInfo = '';
            if (record.source) {
                sourceInfo += `<span class="text-sm text-gray-500">来源: ${escapeHtml(record.source)}</span>`;
            }
            if (record.tag) {
                if (sourceInfo) sourceInfo += ' | ';
                sourceInfo += `<span class="text-sm text-gray-500">标签: ${escapeHtml(record.tag)}</span>`;
            }



            // 构建记录卡片
            html += `
            <div class="bg-white rounded-lg shadow-sm p-4 mb-3 hover:shadow-md transition-all duration-200 hover:shadow-lg" data-type="${record.type}">
                <div class="flex items-start space-x-3">
                    <!-- 类型图标 -->
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 ${typeIcon.bgColor} rounded-full flex items-center justify-center">
                            <svg class="icon ${typeIcon.color}" viewBox="0 0 16 16">${typeIcon.svg}</svg>
                        </div>
                    </div>

                    <!-- 主要内容区域 -->
                    <div class="flex-1 min-w-0">
                        <!-- 头部信息 -->
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-900">${record.type}</span>
                                <span class="text-xs text-gray-400">${record.timestamp}</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                ${actionButton}
                            </div>
                        </div>

                        <!-- 内容预览 -->
                        ${previewContent}

                        <!-- 来源和标签信息 -->
                        <div class="mt-2">
                            ${sourceInfo}
                        </div>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;

        // 绑定复制按钮事件
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function () {
                // 使用 dataset 并解码HTML实体
                let text = this.getAttribute('data-clipboard');
                // 解码HTML实体（如 &#10; 表示换行符）
                const textarea = document.createElement('textarea');
                textarea.innerHTML = text;
                text = textarea.value;

                const svg = this.querySelector('svg');
                const originalHtml = svg.innerHTML;

                // 复制函数
                const doCopy = async () => {
                    try {
                        // 检查是否支持 Clipboard API
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(text);
                        } else {
                            // 降级方案：使用传统的 document.execCommand
                            const textArea = document.createElement('textarea');
                            textArea.value = text;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-9999px';
                            textArea.style.top = '0';
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            const successful = document.execCommand('copy');
                            document.body.removeChild(textArea);
                            if (!successful) {
                                throw new Error('execCommand 复制失败');
                            }
                        }

                        // 显示复制成功状态
                        this.classList.remove('text-blue-500', 'hover:text-blue-700', 'hover:bg-blue-50');
                        this.classList.add('text-green-500', 'bg-green-50');
                        svg.innerHTML = '<path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>';

                        setTimeout(() => {
                            this.classList.remove('text-green-500', 'bg-green-50');
                            this.classList.add('text-blue-500', 'hover:text-blue-700', 'hover:bg-blue-50');
                            svg.innerHTML = originalHtml;
                        }, 2000);
                    } catch (err) {
                        console.error('复制失败:', err);
                        alert('复制失败，请手动复制');
                    }
                };

                doCopy();
            });
        });

        // 绑定文本展开/折叠事件（在渲染后立即绑定）
        document.querySelectorAll('.toggle-text').forEach(button => {
            button.addEventListener('click', function () {
                const container = this.closest('.text-content-container');
                const previewText = container.querySelector('.preview-text');
                const fullText = container.querySelector('.full-text');
                const svg = this.querySelector('svg');
                const label = this.querySelector('.toggle-text-label');

                if (fullText.classList.contains('hidden')) {
                    // 展开：显示完整文本
                    previewText.classList.add('hidden');
                    fullText.classList.remove('hidden');

                    // 更新按钮样式
                    svg.style.transform = 'rotate(180deg)';
                    label.textContent = '收起内容';
                    this.classList.add('text-gray-600');
                    this.classList.remove('text-blue-600');

                    // 添加展开动画
                    fullText.style.maxHeight = '0px';
                    fullText.style.opacity = '0';
                    fullText.style.transition = 'all 0.3s ease-out';

                    setTimeout(() => {
                        fullText.style.maxHeight = '1000px';
                        fullText.style.opacity = '1';
                    }, 10);
                } else {
                    // 收起：显示预览文本
                    previewText.classList.remove('hidden');
                    fullText.classList.add('hidden');

                    // 更新按钮样式
                    svg.style.transform = 'rotate(0deg)';
                    label.textContent = '展开完整内容';
                    this.classList.remove('text-gray-600');
                    this.classList.add('text-blue-600');
                }
            });
        });

        // 绑定图片预览事件
        document.querySelectorAll('.preview-img').forEach(img => {
            img.addEventListener('click', function (e) {
                // 如果按住Ctrl/Cmd键，则复制图片到剪贴板
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    console.log('Ctrl+点击图片，开始复制...');
                    const checksum = this.getAttribute('data-checksum');
                    console.log('图片checksum:', checksum);

                    if (!checksum) {
                        console.error('未找到图片checksum属性');
                        showNotification('图片信息错误，无法复制', 'error');
                        return;
                    }

                    // 查找复制按钮，使用更安全的选择器
                    const copyBtn = this.closest('.bg-white').querySelector('.copy-image-btn');

                    if (copyBtn) {
                        copyImageToClipboard(checksum, copyBtn);
                    } else {
                        // 如果找不到按钮，直接复制但不显示按钮状态
                        copyImageToClipboard(checksum, null);
                    }
                    return;
                }

                // 否则显示预览模态框
                const modal = document.getElementById('image-modal');
                const modalImg = document.getElementById('modal-image');
                const modalTitle = document.getElementById('modal-title');

                modalImg.src = this.getAttribute('data-src');
                modalTitle.textContent = this.getAttribute('data-filename');

                // 更新模态框的图片checksum
                if (window.updateModalImageChecksum) {
                    window.updateModalImageChecksum(this.getAttribute('data-checksum'));
                }

                modal.classList.remove('hidden');
            });
        });



        // 绑定复制图片按钮事件
        document.querySelectorAll('.copy-image-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const icon = this.querySelector('i');

                // 显示处理中状态
                this.classList.add('opacity-50', 'cursor-not-allowed');
                this.disabled = true;

                const checksum = this.getAttribute('data-checksum');
                await copyImageToClipboard(checksum, this);

                // 恢复按钮状态
                setTimeout(() => {
                    this.classList.remove('opacity-50', 'cursor-not-allowed');
                    this.disabled = false;
                }, 2000);
            });
        });

        // 绑定删除按钮事件
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const uuid = this.getAttribute('data-uuid');
                const card = this.closest('.bg-white.rounded-lg');

                // 显示确认对话框
                if (await confirmDelete()) {
                    await deleteRecord(uuid, card);
                }
            });
        });
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 文本格式化函数（移除高亮功能）
    function formatTextDisplay(text) {
        if (!text) return '';

        // 仅转义HTML并保留原样展示，不进行任何自动替换
        return `<span class="text-wrap">${escapeHtml(text)}</span>`;
    }

    // 防止XSS攻击的HTML转义函数
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 转义属性值中的特殊字符（用于 data 属性）
    function escapeAttr(unsafe) {
        if (!unsafe) return '';
        // 先转义HTML特殊字符
        let escaped = escapeHtml(unsafe);
        // 再转义换行符和回车符，因为它们在HTML属性中可能导致问题
        escaped = escaped
            .replace(/\n/g, "&#10;")
            .replace(/\r/g, "&#13;");
        return escaped;
    }

    // 解码属性值（还原HTML实体）
    function decodeAttr(escaped) {
        if (!escaped) return '';
        const textarea = document.createElement('textarea');
        textarea.innerHTML = escaped;
        return textarea.value;
    }


    // 初始化分页事件
    function initPaginationEvents() {
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentOffset > 0) {
                currentOffset -= PAGE_SIZE;
                loadHistory();
                // 滚动到顶部
                window.scrollTo(0, 0);
            }
        });
        document.getElementById('next-page').addEventListener('click', () => {
            if (currentOffset + PAGE_SIZE < totalRecords) {
                currentOffset += PAGE_SIZE;
                loadHistory();
                // 滚动到顶部
                window.scrollTo(0, 0);
            }
        });
    }

    // 更新分页控件状态
    function updatePaginationUI() {
        const totalPages = Math.ceil(totalRecords / PAGE_SIZE);
        const currentPage = Math.floor(currentOffset / PAGE_SIZE) + 1;

        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        document.getElementById('prev-page').disabled = currentOffset === 0;
        document.getElementById('next-page').disabled = currentOffset + PAGE_SIZE >= totalRecords;
        document.getElementById('pagination').classList.remove('hidden');
    }
</script>
{% endblock %}
