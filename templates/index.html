{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <h2 class="text-xl font-bold mb-4">剪贴板历史记录</h2>
    
    <!-- 粘贴提示 -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <div class="flex items-center">
            <i class="fa fa-info-circle text-blue-500 mr-2"></i>
            <span class="text-sm text-blue-700">使用 <kbd class="px-2 py-1 bg-blue-100 rounded text-xs">Ctrl+V</kbd> 粘贴文本或图片 | 图片支持直接复制到剪贴板 | <kbd class="px-2 py-1 bg-blue-100 rounded text-xs">Ctrl+点击图片</kbd> 快速复制</span>
        </div>
    </div>

    <!-- 筛选器 -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <!-- 筛选按钮组 -->
        <div class="flex flex-wrap gap-2">
            <button class="filter-toggle px-3 py-1 rounded-full text-sm hover:bg-gray-100">全部类型</button>
            <button class="filter-toggle px-3 py-1 rounded-full text-sm hover:bg-gray-100">文本</button>
            <button class="filter-toggle px-3 py-1 rounded-full text-sm hover:bg-gray-100">图片</button>
            <button class="filter-toggle px-3 py-1 rounded-full text-sm hover:bg-gray-100">文件</button>
        </div>
    </div>

    <!-- 历史记录列表容器 -->
    <div id="history-list" class="space-y-4">
        <!-- 加载提示 -->
        <div class="bg-white rounded-lg shadow-sm p-8 text-center">
            <i class="fa fa-spinner fa-spin text-primary text-3xl mb-4"></i>
            <p class="text-gray-500">加载历史记录中...</p>
        </div>
    </div>

    <!-- 分页控件 -->
    <div id="pagination" class="mt-6 flex justify-center items-center gap-2 hidden">
        <button id="prev-page" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
            <i class="fa fa-chevron-left mr-1"></i> 上一页
        </button>
        <span class="text-gray-600">
            第 <span id="current-page">1</span> 页 / 共 <span id="total-pages">0</span> 页
        </span>
        <button id="next-page" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
            下一页 <i class="fa fa-chevron-right ml-1"></i>
        </button>
    </div>
</div>

<!-- 图片预览模态框 -->
<div id="image-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center">
    <div class="bg-white p-4 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex justify-between items-center mb-2">
            <h3 id="modal-title" class="font-medium"></h3>
            <div class="flex items-center space-x-2">
                <button id="modal-copy-image" class="text-blue-500 hover:text-blue-700">
                    <i class="fa fa-copy"></i> 复制图片
                </button>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="flex justify-center items-center h-[calc(90vh-60px)]">
            <img id="modal-image" src="" alt="图片预览" class="max-w-full max-h-full object-contain">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const PAGE_SIZE = 30;
    let currentOffset = 0;
    let totalRecords = 0;

    // 页面加载后初始化
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        initPaginationEvents();
        initModalEvents();
        initPasteEvents();
    });

    // 初始化模态框事件
    function initModalEvents() {
        const modal = document.getElementById('image-modal');
        const closeBtn = document.getElementById('close-modal');
        const copyBtn = document.getElementById('modal-copy-image');
        let currentImageChecksum = null;

        // 点击关闭按钮关闭模态框
        closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        // 点击复制按钮复制图片
        copyBtn.addEventListener('click', () => {
            if (currentImageChecksum) {
                copyImageToClipboard(currentImageChecksum, copyBtn);
            }
        });

        // 点击模态框外部关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });

        // 存储当前图片的checksum供复制使用
        window.updateModalImageChecksum = function(checksum) {
            currentImageChecksum = checksum;
        };
    }

    // 初始化粘贴事件
    function initPasteEvents() {
        document.addEventListener('paste', handlePaste);
    }

    // 处理粘贴事件
    async function handlePaste(e) {
        e.preventDefault();
        
        const items = e.clipboardData.items;
        let processed = false;

        // 显示处理中提示
        showPasteProcessing();

        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                // 处理图片粘贴
                const blob = item.getAsFile();
                await handleImagePaste(blob);
                processed = true;
                break;
            } else if (item.type === 'text/plain') {
                // 处理文本粘贴
                const text = e.clipboardData.getData('text/plain');
                await handleTextPaste(text);
                processed = true;
                break;
            }
        }

        if (!processed) {
            hidePasteProcessing();
            showNotification('不支持的粘贴内容类型', 'error');
        }
    }

    // 处理文本粘贴
    async function handleTextPaste(text) {
        try {
            const response = await fetch('/api/paste/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: text,
                    type: 'Text'
                })
            });

            const result = await response.json();
            if (result.success) {
                showNotification('文本已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('文本粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 处理图片粘贴
    async function handleImagePaste(blob) {
        try {
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('type', 'Image');

            const response = await fetch('/api/paste/image', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showNotification('图片已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('图片粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 显示粘贴处理中状态
    function showPasteProcessing() {
        const processingDiv = document.createElement('div');
        processingDiv.id = 'paste-processing';
        processingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        processingDiv.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在处理粘贴内容...';
        document.body.appendChild(processingDiv);
    }

    // 隐藏粘贴处理中状态
    function hidePasteProcessing() {
        const processingDiv = document.getElementById('paste-processing');
        if (processingDiv) {
            processingDiv.remove();
        }
    }

    // 显示通知
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-gray-500 text-white'
        }`;
        notification.innerHTML = message;
        document.body.appendChild(notification);

        // 3秒后自动移除
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // 复制图片到剪贴板
    async function copyImageToClipboard(checksum, buttonElement) {
        console.log('开始复制图片，checksum:', checksum, '按钮:', buttonElement);
        
        try {
            if (!checksum) {
                throw new Error('图片checksum为空');
            }
            
            // 获取图片数据
            const response = await fetch(`/api/download?checksum=${checksum}`);
            if (!response.ok) {
                throw new Error('获取图片失败: ' + response.statusText);
            }

            const blob = await response.blob();
            console.log('获取图片blob成功，类型:', blob.type, '大小:', blob.size);
            
            // 检查是否支持Clipboard API
            if (navigator.clipboard && navigator.clipboard.write) {
                console.log('浏览器支持Clipboard API，开始复制...');
                // 创建ClipboardItem对象
                const clipboardItem = new ClipboardItem({
                    [blob.type]: blob
                });
                
                // 写入剪贴板
                await navigator.clipboard.write([clipboardItem]);
                console.log('复制到剪贴板成功');
                
                // 如果有按钮元素，显示成功状态
                if (buttonElement && buttonElement.innerHTML) {
                    console.log('更新按钮状态');
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = '<i class="fa fa-check"></i> 已复制';
                    buttonElement.classList.remove('text-blue-500');
                    buttonElement.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        if (buttonElement) {
                            buttonElement.innerHTML = originalText;
                            buttonElement.classList.remove('text-green-500');
                            buttonElement.classList.add('text-blue-500');
                        }
                    }, 2000);
                }
                
                showNotification('图片已复制到剪贴板', 'success');
            } else {
                // 浏览器不支持Clipboard API，提示用户使用下载
                console.log('浏览器不支持Clipboard API');
                showNotification('您的浏览器不支持直接复制图片，请使用下载功能', 'error');
            }
            
        } catch (error) {
            console.error('复制图片失败:', error);
            showNotification('复制图片失败: ' + error.message, 'error');
        }
    }

    // 加载历史记录
    function loadHistory() {
        const container = document.getElementById('history-list');
        container.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                <i class="fa fa-spinner fa-spin text-primary text-3xl mb-4"></i>
                <p class="text-gray-500">加载历史记录中...</p>
            </div>
        `; // 显示加载中

        fetch(`/api/history?limit=${PAGE_SIZE}&offset=${currentOffset}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    totalRecords = data.data.total;
                    renderRecords(data.data.records);
                    updatePaginationUI();
                } else {
                    container.innerHTML = `<div class="text-center text-red-500">加载失败: ${data.error}</div>`;
                }
            });
    }

    // 渲染记录列表
    function renderRecords(records) {
        const container = document.getElementById('history-list');
        if (records.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                    <p class="text-gray-500">暂无历史记录</p>
                </div>
            `;
            return;
        }

        let html = '';
        records.forEach(record => {
            // 根据类型生成不同的内容预览
            let previewContent = '';
            let actionButton = '';
            let extraInfo = '';

            if (record.type === 'Text') {
                // 文本类型：显示内容预览和复制按钮
                const maxLength = 100;
                const content = record.content || '';
                const isLongText = content.length > maxLength;
                const preview = isLongText
                    ? content.substring(0, maxLength) + '...'
                    : content;

                // 构建预览内容（带展开/折叠功能）
                previewContent = `
                    <div class="text-gray-700 text-wrap">
                        <span class="${isLongText ? 'preview-text' : ''}">${escapeHtml(preview)}</span>
                        ${isLongText ? `<span class="full-text hidden">${escapeHtml(content)}</span>` : ''}
                    </div>
                    ${isLongText ? `
                        <button class="toggle-text text-sm text-blue-500 hover:text-blue-700 mt-1">
                            展开
                        </button>
                    ` : ''}
                `;

                actionButton = `
                    <button class="copy-btn text-blue-500 hover:text-blue-700" data-clipboard="${escapeHtml(content)}">
                        <i class="fa fa-copy"></i> 复制
                    </button>
                `;
            }
            else if (record.type === 'Image') {
                // 图片类型：显示缩略图和复制按钮
                const fileName = record.file_name || '未知图片';

                previewContent = `
                    <div class="mt-1">
                        <img src="/api/download?checksum=${record.checksum}" 
                             alt="${escapeHtml(fileName)}" 
                             class="max-h-32 max-w-full rounded border border-gray-200 cursor-pointer preview-img"
                             data-filename="${escapeHtml(fileName)}"
                             data-src="/api/download?checksum=${record.checksum}"
                             data-checksum="${record.checksum}">
                        <p class="text-sm text-gray-600 mt-1">${escapeHtml(fileName)}</p>
                    </div>
                `;

                actionButton = `
                    <button class="copy-image-btn text-blue-500 hover:text-blue-700" data-checksum="${record.checksum}">
                        <i class="fa fa-copy"></i> 复制图片
                    </button>
                    <a href="/api/download?checksum=${record.checksum}" class="text-blue-500 hover:text-blue-700 ml-2" download>
                        <i class="fa fa-download"></i> 下载
                    </a>
                `;
            }
            else if (record.type === 'File' || record.type === 'Group') {
                // 文件类型：显示文件名和下载按钮
                const fileName = record.file_name || '未知文件';

                // 获取文件大小信息（这里假设后端会返回，如果没有可以去掉）
                if (record.size) {
                    extraInfo = `<div class="text-xs text-gray-400 mt-1">
                        文件大小: ${formatFileSize(record.size)}
                    </div>`;
                }

                previewContent = `
                    <div class="text-gray-700 truncate">
                        <i class="fa fa-file-o mr-1"></i> ${escapeHtml(fileName)}
                    </div>
                    ${extraInfo}
                `;

                actionButton = `
                    <a href="/api/download?checksum=${record.checksum}" class="text-blue-500 hover:text-blue-700" download>
                        <i class="fa fa-download"></i> 下载
                    </a>
                `;
            }

            // 来源和标签信息
            let sourceInfo = '';
            if (record.source) {
                sourceInfo += `<span class="text-sm text-gray-500">来源: ${escapeHtml(record.source)}</span>`;
            }
            if (record.tag) {
                if (sourceInfo) sourceInfo += ' | ';
                sourceInfo += `<span class="text-sm text-gray-500">标签: ${escapeHtml(record.tag)}</span>`;
            }

            // 收藏图标
            const favoriteClass = record.is_favorite ? 'text-yellow-500' : 'text-gray-300';
            const favoriteAction = record.is_favorite ? 'unfavorite' : 'favorite';

            // 构建记录卡片
            html += `
            <div class="bg-white rounded-lg shadow-sm p-3 mb-2 hover:shadow-md transition-custom">
                <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-900">${record.type}</span>
                            <span class="ml-2 text-xs text-gray-500">${record.timestamp}</span>
                        </div>
                        ${previewContent}
                        <div class="mt-1">
                            ${sourceInfo}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="favorite-btn ${favoriteClass}" data-uuid="${record.uuid}" data-action="${favoriteAction}">
                            <i class="fa fa-star"></i>
                        </button>
                        ${actionButton}
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;

        // 绑定复制按钮事件
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function () {
                const text = this.getAttribute('data-clipboard');
                navigator.clipboard.writeText(text).then(() => {
                    // 显示复制成功提示
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fa fa-check"></i> 已复制';
                    this.classList.remove('text-blue-500');
                    this.classList.add('text-green-500');

                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.classList.remove('text-green-500');
                        this.classList.add('text-blue-500');
                    }, 2000);
                }).catch(err => {
                    console.error('复制失败:', err);
                });
            });
        });

        // 绑定文本展开/折叠事件（在渲染后立即绑定）
        document.querySelectorAll('.toggle-text').forEach(button => {
            button.addEventListener('click', function () {
                const previewText = this.parentElement.querySelector('.preview-text');
                const fullText = this.parentElement.querySelector('.full-text');

                if (fullText.classList.contains('hidden')) {
                    // 切换到显示完整文本
                    previewText.classList.add('hidden');
                    fullText.classList.remove('hidden');
                    this.textContent = '收起';
                } else {
                    // 切换到显示预览文本
                    previewText.classList.remove('hidden');
                    fullText.classList.add('hidden');
                    this.textContent = '展开';
                }
            });
        });

        // 绑定图片预览事件
        document.querySelectorAll('.preview-img').forEach(img => {
            img.addEventListener('click', function (e) {
                // 如果按住Ctrl/Cmd键，则复制图片到剪贴板
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    console.log('Ctrl+点击图片，开始复制...');
                    const checksum = this.getAttribute('data-checksum');
                    console.log('图片checksum:', checksum);
                    
                    if (!checksum) {
                        console.error('未找到图片checksum属性');
                        showNotification('图片信息错误，无法复制', 'error');
                        return;
                    }
                    
                    // 查找复制按钮，使用更安全的选择器
                    const copyBtn = this.closest('.bg-white').querySelector('.copy-image-btn');
                    console.log('找到复制按钮:', copyBtn);
                    
                    if (copyBtn) {
                        copyImageToClipboard(checksum, copyBtn);
                    } else {
                        console.log('未找到复制按钮，使用直接复制');
                        // 如果找不到按钮，直接复制但不显示按钮状态
                        copyImageToClipboard(checksum, null);
                    }
                    return;
                }
                
                // 否则显示预览模态框
                const modal = document.getElementById('image-modal');
                const modalImg = document.getElementById('modal-image');
                const modalTitle = document.getElementById('modal-title');

                modalImg.src = this.getAttribute('data-src');
                modalTitle.textContent = this.getAttribute('data-filename');
                
                // 更新模态框的图片checksum
                if (window.updateModalImageChecksum) {
                    window.updateModalImageChecksum(this.getAttribute('data-checksum'));
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });
        });

        // 绑定收藏按钮事件
        document.querySelectorAll('.favorite-btn').forEach(button => {
            button.addEventListener('click', function () {
                const uuid = this.getAttribute('data-uuid');
                const isFavorite = this.classList.contains('text-yellow-500');

                // 这里应该调用后端API来更新收藏状态
                // 为了演示，先做前端状态切换
                if (isFavorite) {
                    this.classList.remove('text-yellow-500');
                    this.classList.add('text-gray-300');
                } else {
                    this.classList.remove('text-gray-300');
                    this.classList.add('text-yellow-500');
                }
            });
        });

        // 绑定复制图片按钮事件
        document.querySelectorAll('.copy-image-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const checksum = this.getAttribute('data-checksum');
                await copyImageToClipboard(checksum, this);
            });
        });
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 防止XSS攻击的HTML转义函数
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 初始化分页事件
    function initPaginationEvents() {
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentOffset > 0) {
                currentOffset -= PAGE_SIZE;
                loadHistory();
                // 滚动到顶部
                window.scrollTo(0, 0);
            }
        });
        document.getElementById('next-page').addEventListener('click', () => {
            if (currentOffset + PAGE_SIZE < totalRecords) {
                currentOffset += PAGE_SIZE;
                loadHistory();
                // 滚动到顶部
                window.scrollTo(0, 0);
            }
        });
    }

    // 更新分页控件状态
    function updatePaginationUI() {
        const totalPages = Math.ceil(totalRecords / PAGE_SIZE);
        const currentPage = Math.floor(currentOffset / PAGE_SIZE) + 1;

        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        document.getElementById('prev-page').disabled = currentOffset === 0;
        document.getElementById('next-page').disabled = currentOffset + PAGE_SIZE >= totalRecords;
        document.getElementById('pagination').classList.remove('hidden');
    }
</script>
{% endblock %}