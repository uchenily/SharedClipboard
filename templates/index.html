{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <h2 class="text-xl font-bold mb-4">剪贴板历史记录</h2>
    
    <!-- 粘贴和拖拽提示 -->
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-xl p-4 mb-6 shadow-sm">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    <i class="fa fa-info text-white"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-700">
                        <kbd class="px-2 py-1 bg-white rounded text-xs font-mono shadow-sm border border-gray-200">Ctrl+V</kbd>
                        <span class="mx-2 text-gray-400">|</span>
                        粘贴内容
                        <span class="mx-2 text-gray-400">|</span>
                        <kbd class="px-2 py-1 bg-white rounded text-xs font-mono shadow-sm border border-gray-200">拖拽</kbd>
                        <span class="mx-2 text-gray-400">|</span>
                        上传文件
                        <span class="mx-2 text-gray-400">|</span>
                        <kbd class="px-2 py-1 bg-white rounded text-xs font-mono shadow-sm border border-gray-200">Ctrl+点击图片</kbd>
                        <span class="mx-2 text-gray-400">|</span>
                        快速复制
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 拖拽区域 -->
    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 mb-6 text-center transition-all duration-300 hover:border-blue-400 hover:bg-blue-50/30 cursor-pointer group">
        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
            <i class="fa fa-cloud-upload text-white text-2xl"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">拖拽文件到此处上传</h3>
        <p class="text-gray-500 text-sm mb-6">支持文本、图片和任意文件类型 • 支持批量上传</p>
        <button class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-105 shadow-lg">
            <i class="fa fa-folder-open mr-2"></i>选择文件
        </button>
    </div>
    
    <!-- 隐藏的文件输入元素 -->
    <input type="file" id="file-input" multiple class="hidden" accept="*/*">

    <!-- 筛选器 -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <!-- 筛选按钮组 -->
        <div class="flex flex-wrap gap-2">
            <button class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="all">
                <i class="fa fa-th-large"></i>
                <span>全部类型</span>
            </button>
            <button class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="Text">
                <i class="fa fa-file-text-o text-blue-500"></i>
                <span>文本</span>
            </button>
            <button class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="Image">
                <i class="fa fa-picture-o text-green-500"></i>
                <span>图片</span>
            </button>
            <button class="filter-toggle flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:bg-gray-50" data-type="File">
                <i class="fa fa-file-o text-purple-500"></i>
                <span>文件</span>
            </button>
        </div>
    </div>

    <!-- 历史记录列表容器 -->
    <div id="history-list" class="space-y-4">
        <!-- 加载提示 -->
        <div class="bg-white rounded-lg shadow-sm p-8 text-center">
            <i class="fa fa-spinner fa-spin text-primary text-3xl mb-4"></i>
            <p class="text-gray-500">加载历史记录中...</p>
        </div>
    </div>

    <!-- 分页控件 -->
    <div id="pagination" class="mt-6 flex justify-center items-center gap-2 hidden">
        <button id="prev-page" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
            <i class="fa fa-chevron-left mr-1"></i> 上一页
        </button>
        <span class="text-gray-600">
            第 <span id="current-page">1</span> 页 / 共 <span id="total-pages">0</span> 页
        </span>
        <button id="next-page" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
            下一页 <i class="fa fa-chevron-right ml-1"></i>
        </button>
    </div>
</div>

<!-- 图片预览模态框 -->
<div id="image-modal" class="fixed inset-0 bg-black z-50 hidden">
    <!-- 顶部控制栏 -->
    <div class="absolute top-0 left-0 right-0 bg-black/50 text-white p-4 z-10">
        <div class="flex justify-between items-center">
            <h3 id="modal-title" class="font-medium truncate max-w-md"></h3>
            <div class="flex items-center space-x-4">
                <button id="modal-copy-image" class="text-white hover:text-blue-300 transition-colors">
                    <i class="fa fa-copy mr-2"></i>复制
                </button>
                <button id="close-modal" class="text-white hover:text-gray-300 transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- 图片容器 -->
    <div class="w-full h-full flex items-center justify-center p-4">
        <img id="modal-image" src="" alt="图片预览" class="max-w-full max-h-full object-contain">
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const PAGE_SIZE = 30;
    let currentOffset = 0;
    let totalRecords = 0;

    // 页面加载后初始化
    document.addEventListener('DOMContentLoaded', () => {
        loadHistory();
        initPaginationEvents();
        initModalEvents();
        initPasteEvents();
        initDragAndDropEvents();
        initFilterEvents();
    });

    // 初始化模态框事件
    function initModalEvents() {
        const modal = document.getElementById('image-modal');
        const closeBtn = document.getElementById('close-modal');
        const copyBtn = document.getElementById('modal-copy-image');
        const modalImg = document.getElementById('modal-image');
        let currentImageChecksum = null;

        // 点击关闭按钮关闭模态框
        closeBtn.addEventListener('click', () => {
            closeModal();
        });

        // 点击复制按钮复制图片
        copyBtn.addEventListener('click', () => {
            if (currentImageChecksum) {
                copyImageToClipboard(currentImageChecksum, copyBtn);
            }
        });

        // ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // 点击模态框外部关闭（点击背景黑色区域）
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // 点击图片也能关闭模态框
        modalImg.addEventListener('click', () => {
            closeModal();
        });

        // 存储当前图片的checksum供复制使用
        window.updateModalImageChecksum = function(checksum) {
            currentImageChecksum = checksum;
        };

        // 关闭模态框的函数
        function closeModal() {
            modal.classList.add('hidden');
            // 清空图片src以释放内存
            modalImg.src = '';
        }
    }

    // 初始化粘贴事件
    function initPasteEvents() {
        document.addEventListener('paste', handlePaste);
    }

    // 初始化拖拽事件
    function initDragAndDropEvents() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        
        // 防止浏览器默认行为
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // 高亮拖拽区域
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        // 处理拖拽的文件
        dropZone.addEventListener('drop', handleDrop, false);
        
        // 点击拖拽区域触发文件选择
        dropZone.addEventListener('click', function(e) {
            // 防止按钮点击时重复触发
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                e.preventDefault();
            }
            fileInput.click();
        });
        
        // 处理文件选择
        fileInput.addEventListener('change', handleFileSelect, false);
    }

    // 阻止默认行为
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // 高亮拖拽区域
    function highlight(e) {
        document.getElementById('drop-zone').classList.add('border-blue-500', 'bg-blue-50');
        document.getElementById('drop-zone').classList.remove('border-gray-300');
    }

    // 取消高亮
    function unhighlight(e) {
        document.getElementById('drop-zone').classList.remove('border-blue-500', 'bg-blue-50');
        document.getElementById('drop-zone').classList.add('border-gray-300');
    }

    // 处理拖拽的文件
    async function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            // 处理所有拖拽的文件
            for (let file of files) {
                await handleDroppedFile(file);
            }
        }
    }

    // 处理选择的文件
    async function handleFileSelect(e) {
        const files = e.target.files;
        
        if (files.length > 0) {
            // 处理所有选择的文件
            for (let file of files) {
                await handleDroppedFile(file);
            }
        }
        
        // 清空input，允许重复选择同一文件
        e.target.value = '';
    }

    // 处理单个拖拽的文件
    async function handleDroppedFile(file) {
        // 显示处理中提示
        showDropProcessing(file.name);

        try {
            if (file.type.startsWith('image/')) {
                // 处理图片文件
                await handleImageDrop(file);
            } else if (file.type.startsWith('text/')) {
                // 处理文本文件
                await handleTextFileDrop(file);
            } else {
                // 处理其他文件类型
                await handleFileDrop(file);
            }
        } catch (error) {
            console.error('文件拖拽错误:', error);
            showNotification(`处理文件 ${file.name} 失败: ${error.message}`, 'error');
        } finally {
            hideDropProcessing();
        }
    }

    // 处理图片文件拖拽
    async function handleImageDrop(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'Image');

        const response = await fetch('/api/paste/image', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            showNotification(`图片 ${file.name} 已添加到剪贴板历史`, 'success');
            // 刷新历史记录，显示最新内容
            currentOffset = 0;
            loadHistory();
        } else {
            showNotification(`添加图片失败: ${result.error}`, 'error');
        }
    }

    // 处理文本文件拖拽
    async function handleTextFileDrop(file) {
        try {
            const text = await file.text();
            await handleTextPaste(text);
            showNotification(`文本文件 ${file.name} 内容已添加到剪贴板历史`, 'success');
        } catch (error) {
            showNotification(`读取文本文件 ${file.name} 失败`, 'error');
        }
    }

    // 处理其他文件类型拖拽
    async function handleFileDrop(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', 'File');

        const response = await fetch('/api/paste/file', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (result.success) {
            showNotification(`文件 ${file.name} 已添加到剪贴板历史`, 'success');
            // 刷新历史记录，显示最新内容
            currentOffset = 0;
            loadHistory();
        } else {
            showNotification(`添加文件失败: ${result.error}`, 'error');
        }
    }

    // 显示拖拽处理中状态
    function showDropProcessing(fileName) {
        const processingDiv = document.createElement('div');
        processingDiv.id = 'drop-processing';
        processingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        processingDiv.innerHTML = `<i class="fa fa-spinner fa-spin mr-2"></i>正在处理文件: ${fileName}`;
        document.body.appendChild(processingDiv);
    }

    // 隐藏拖拽处理中状态
    function hideDropProcessing() {
        const processingDiv = document.getElementById('drop-processing');
        if (processingDiv) {
            processingDiv.remove();
        }
    }

    // 初始化筛选事件
    function initFilterEvents() {
        const filterButtons = document.querySelectorAll('.filter-toggle');
        let currentFilter = 'all'; // 默认显示全部类型
        let allRecords = []; // 存储所有记录
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                const filterType = this.getAttribute('data-type');
                
                // 更新按钮状态
                filterButtons.forEach(btn => {
                    btn.classList.remove('bg-primary/10', 'text-primary');
                });
                this.classList.add('bg-primary/10', 'text-primary');
                
                currentFilter = filterType;
                
                // 筛选并重新渲染记录
                filterAndRenderRecords(filterType);
            });
        });
        
        // 将筛选后的记录渲染函数暴露给全局
        window.filterAndRenderRecords = function(filterType) {
            const container = document.getElementById('history-list');
            const records = container.querySelectorAll('.bg-white.rounded-lg.shadow-sm');
            
            records.forEach(record => {
                const recordType = record.querySelector('.text-sm.font-medium.text-gray-900')?.textContent;
                
                if (filterType === 'all') {
                    record.style.display = 'block';
                } else {
                    record.style.display = recordType === filterType ? 'block' : 'none';
                }
            });
            
            // 更新显示的记录数量
            const visibleRecords = Array.from(records).filter(record => record.style.display !== 'none');
            updateVisibleCount(visibleRecords.length);
        };
        
        // 更新可见记录数量
        window.updateVisibleCount = function(count) {
            // 可以在这里添加显示记录数量的逻辑
            console.log(`显示 ${count} 条记录`);
        };
    }

    // 处理粘贴事件
    async function handlePaste(e) {
        e.preventDefault();
        
        const items = e.clipboardData.items;
        let processed = false;

        // 显示处理中提示
        showPasteProcessing();

        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                // 处理图片粘贴
                const blob = item.getAsFile();
                await handleImagePaste(blob);
                processed = true;
                break;
            } else if (item.type === 'text/plain') {
                // 处理文本粘贴
                const text = e.clipboardData.getData('text/plain');
                await handleTextPaste(text);
                processed = true;
                break;
            } else if (item.kind === 'file') {
                // 处理文件粘贴
                const file = item.getAsFile();
                await handleFilePaste(file);
                processed = true;
                break;
            }
        }

        if (!processed) {
            hidePasteProcessing();
            showNotification('不支持的粘贴内容类型', 'error');
        }
    }

    // 处理文本粘贴
    async function handleTextPaste(text) {
        try {
            const response = await fetch('/api/paste/text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: text,
                    type: 'Text'
                })
            });

            const result = await response.json();
            if (result.success) {
                showNotification('文本已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('文本粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 处理图片粘贴
    async function handleImagePaste(blob) {
        try {
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('type', 'Image');

            const response = await fetch('/api/paste/image', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showNotification('图片已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('图片粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 处理文件粘贴
    async function handleFilePaste(file) {
        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', 'File');

            const response = await fetch('/api/paste/file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showNotification('文件已添加到剪贴板历史', 'success');
                // 刷新历史记录，显示最新内容
                currentOffset = 0;
                loadHistory();
            } else {
                showNotification('添加失败: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('文件粘贴错误:', error);
            showNotification('添加失败', 'error');
        } finally {
            hidePasteProcessing();
        }
    }

    // 显示粘贴处理中状态
    function showPasteProcessing() {
        const processingDiv = document.createElement('div');
        processingDiv.id = 'paste-processing';
        processingDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        processingDiv.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在处理粘贴内容...';
        document.body.appendChild(processingDiv);
    }

    // 隐藏粘贴处理中状态
    function hidePasteProcessing() {
        const processingDiv = document.getElementById('paste-processing');
        if (processingDiv) {
            processingDiv.remove();
        }
    }

    // 显示通知
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-gray-500 text-white'
        }`;
        notification.innerHTML = message;
        document.body.appendChild(notification);

        // 3秒后自动移除
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // 复制图片到剪贴板
    async function copyImageToClipboard(checksum, buttonElement) {
        console.log('开始复制图片，checksum:', checksum, '按钮:', buttonElement);
        
        try {
            if (!checksum) {
                throw new Error('图片checksum为空');
            }
            
            // 获取图片数据
            const response = await fetch(`/api/download?checksum=${checksum}`);
            if (!response.ok) {
                throw new Error('获取图片失败: ' + response.statusText);
            }

            const blob = await response.blob();
            console.log('获取图片blob成功，类型:', blob.type, '大小:', blob.size);
            
            // 检查是否支持Clipboard API
            if (navigator.clipboard && navigator.clipboard.write) {
                console.log('浏览器支持Clipboard API，开始复制...');
                // 创建ClipboardItem对象
                const clipboardItem = new ClipboardItem({
                    [blob.type]: blob
                });
                
                // 写入剪贴板
                await navigator.clipboard.write([clipboardItem]);
                console.log('复制到剪贴板成功');
                
                // 如果有按钮元素，显示成功状态
                if (buttonElement && buttonElement.innerHTML) {
                    console.log('更新按钮状态');
                    const originalText = buttonElement.innerHTML;
                    buttonElement.innerHTML = '<i class="fa fa-check"></i> 已复制';
                    buttonElement.classList.remove('text-blue-500');
                    buttonElement.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        if (buttonElement) {
                            buttonElement.innerHTML = originalText;
                            buttonElement.classList.remove('text-green-500');
                            buttonElement.classList.add('text-blue-500');
                        }
                    }, 2000);
                }
                
                showNotification('图片已复制到剪贴板', 'success');
            } else {
                // 浏览器不支持Clipboard API，提示用户使用下载
                console.log('浏览器不支持Clipboard API');
                showNotification('您的浏览器不支持直接复制图片，请使用下载功能', 'error');
            }
            
        } catch (error) {
            console.error('复制图片失败:', error);
            showNotification('复制图片失败: ' + error.message, 'error');
        }
    }

    // 加载历史记录
    function loadHistory() {
        const container = document.getElementById('history-list');
        container.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                <i class="fa fa-spinner fa-spin text-primary text-3xl mb-4"></i>
                <p class="text-gray-500">加载历史记录中...</p>
            </div>
        `; // 显示加载中

        fetch(`/api/history?limit=${PAGE_SIZE}&offset=${currentOffset}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    totalRecords = data.data.total;
                    renderRecords(data.data.records);
                    updatePaginationUI();
                } else {
                    container.innerHTML = `<div class="text-center text-red-500">加载失败: ${data.error}</div>`;
                }
            });
    }

    // 获取类型对应的图标
    function getTypeIcon(type) {
        const iconMap = {
            'Text': {
                icon: 'fa-file-text-o',
                color: 'text-blue-500',
                bgColor: 'bg-blue-100'
            },
            'Image': {
                icon: 'fa-picture-o',
                color: 'text-green-500',
                bgColor: 'bg-green-100'
            },
            'File': {
                icon: 'fa-file-o',
                color: 'text-purple-500',
                bgColor: 'bg-purple-100'
            }
        };
        
        const typeInfo = iconMap[type] || iconMap['File'];
        return typeInfo;
    }

    // 渲染记录列表
    function renderRecords(records) {
        const container = document.getElementById('history-list');
        if (records.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                    <p class="text-gray-500">暂无历史记录</p>
                </div>
            `;
            return;
        }

        let html = '';
        records.forEach(record => {
            // 获取类型图标信息
            const typeIcon = getTypeIcon(record.type);
            
            // 根据类型生成不同的内容预览
            let previewContent = '';
            let actionButton = '';
            let extraInfo = '';

            if (record.type === 'Text') {
                // 文本类型：显示内容预览和复制按钮
                const maxLength = 100;
                const content = record.content || '';
                const isLongText = content.length > maxLength;
                const preview = isLongText
                    ? content.substring(0, maxLength) + '...'
                    : content;

                // 构建预览内容（带展开/折叠功能）
                previewContent = `
                    <div class="text-content-container">
                        <div class="text-preview bg-gradient-to-br from-gray-50 to-blue-50/30 rounded-xl p-4 border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-2 right-2 text-xs text-gray-400 bg-white/80 px-2 py-1 rounded-full">
                                ${content.length} 字符
                            </div>
                            <div class="${isLongText ? 'preview-text' : ''} text-gray-700 leading-relaxed">
                                ${formatTextDisplay(isLongText ? preview : content)}
                            </div>
                            ${isLongText ? `
                                <div class="full-text hidden text-gray-700 leading-relaxed">
                                    ${formatTextDisplay(content)}
                                </div>
                            ` : ''}
                        </div>
                        ${isLongText ? `
                            <button class="toggle-text flex items-center space-x-2 text-sm text-blue-600 hover:text-blue-700 mt-3 font-medium transition-colors duration-200 group">
                                <i class="fa fa-chevron-down transition-transform duration-200"></i>
                                <span class="toggle-text-label">展开完整内容</span>
                            </button>
                        ` : ''}
                    </div>
                `;

                actionButton = `
                    <button class="copy-btn text-blue-500 hover:text-blue-700 hover:bg-blue-50 px-2 py-1 rounded transition-all duration-200" data-clipboard="${escapeHtml(content)}">
                        <i class="fa fa-copy"></i>
                        <span class="ml-1 text-xs">复制</span>
                    </button>
                `;
            }
            else if (record.type === 'Image') {
                // 图片类型：显示缩略图和复制按钮
                const fileName = record.file_name || '未知图片';

                previewContent = `
                    <div class="mt-2">
                        <div class="relative inline-block group">
                            <img src="/api/download?checksum=${record.checksum}" 
                                 alt="${escapeHtml(fileName)}" 
                                 class="max-h-36 max-w-full rounded-lg border border-gray-200 cursor-pointer preview-img hover:border-blue-400 hover:shadow-md transition-all duration-200"
                                 data-filename="${escapeHtml(fileName)}"
                                 data-src="/api/download?checksum=${record.checksum}"
                                 data-checksum="${record.checksum}">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 rounded-lg transition-all duration-200 pointer-events-none"></div>
                            <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <i class="fa fa-search-plus"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 font-medium">${escapeHtml(fileName)}</p>
                    </div>
                `;

                actionButton = `
                    <button class="copy-image-btn text-blue-500 hover:text-blue-700" data-checksum="${record.checksum}">
                        <i class="fa fa-copy"></i> 复制图片
                    </button>
                    <a href="/api/download?checksum=${record.checksum}" class="text-blue-500 hover:text-blue-700 ml-2" download>
                        <i class="fa fa-download"></i> 下载
                    </a>
                `;
            }
            else if (record.type === 'File' || record.type === 'Group') {
                // 文件类型：显示文件名和下载按钮
                const fileName = record.file_name || '未知文件';

                // 获取文件大小信息（这里假设后端会返回，如果没有可以去掉）
                if (record.size) {
                    extraInfo = `<div class="text-xs text-gray-400 mt-1">
                        文件大小: ${formatFileSize(record.size)}
                    </div>`;
                }

                previewContent = `
                    <div class="flex items-center space-x-2 bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div class="w-8 h-8 bg-gray-200 rounded flex items-center justify-center">
                            <i class="fa fa-file text-gray-500"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-700 truncate font-medium">${escapeHtml(fileName)}</p>
                            ${extraInfo ? `<div class="text-xs text-gray-500 mt-1">${extraInfo}</div>` : ''}
                        </div>
                    </div>
                `;

                actionButton = `
                    <a href="/api/download?checksum=${record.checksum}" class="text-blue-500 hover:text-blue-700" download>
                        <i class="fa fa-download"></i> 下载
                    </a>
                `;
            }

            // 来源和标签信息
            let sourceInfo = '';
            if (record.source) {
                sourceInfo += `<span class="text-sm text-gray-500">来源: ${escapeHtml(record.source)}</span>`;
            }
            if (record.tag) {
                if (sourceInfo) sourceInfo += ' | ';
                sourceInfo += `<span class="text-sm text-gray-500">标签: ${escapeHtml(record.tag)}</span>`;
            }

            // 收藏图标
            const favoriteClass = record.is_favorite ? 'text-yellow-500' : 'text-gray-300';
            const favoriteAction = record.is_favorite ? 'unfavorite' : 'favorite';

            // 构建记录卡片
            html += `
            <div class="bg-white rounded-lg shadow-sm p-4 mb-3 hover:shadow-md transition-all duration-200 hover:shadow-lg" data-type="${record.type}">
                <div class="flex items-start space-x-3">
                    <!-- 类型图标 -->
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 ${typeIcon.bgColor} rounded-full flex items-center justify-center">
                            <i class="fa ${typeIcon.icon} ${typeIcon.color}"></i>
                        </div>
                    </div>
                    
                    <!-- 主要内容区域 -->
                    <div class="flex-1 min-w-0">
                        <!-- 头部信息 -->
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-900">${record.type}</span>
                                <span class="text-xs text-gray-400">${record.timestamp}</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <button class="favorite-btn ${favoriteClass} hover:scale-110 transition-transform" data-uuid="${record.uuid}" data-action="${favoriteAction}">
                                    <i class="fa fa-star"></i>
                                </button>
                                ${actionButton}
                            </div>
                        </div>
                        
                        <!-- 内容预览 -->
                        ${previewContent}
                        
                        <!-- 来源和标签信息 -->
                        <div class="mt-2">
                            ${sourceInfo}
                        </div>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;

        // 绑定复制按钮事件
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function () {
                const text = this.getAttribute('data-clipboard');
                navigator.clipboard.writeText(text).then(() => {
                    // 显示复制成功提示
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fa fa-check"></i> 已复制';
                    this.classList.remove('text-blue-500');
                    this.classList.add('text-green-500');

                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.classList.remove('text-green-500');
                        this.classList.add('text-blue-500');
                    }, 2000);
                }).catch(err => {
                    console.error('复制失败:', err);
                });
            });
        });

        // 绑定文本展开/折叠事件（在渲染后立即绑定）
        document.querySelectorAll('.toggle-text').forEach(button => {
            button.addEventListener('click', function () {
                const container = this.closest('.text-content-container');
                const previewText = container.querySelector('.preview-text');
                const fullText = container.querySelector('.full-text');
                const icon = this.querySelector('i');
                const label = this.querySelector('.toggle-text-label');

                if (fullText.classList.contains('hidden')) {
                    // 展开：显示完整文本
                    previewText.classList.add('hidden');
                    fullText.classList.remove('hidden');
                    
                    // 更新按钮样式
                    icon.style.transform = 'rotate(180deg)';
                    label.textContent = '收起内容';
                    this.classList.add('text-gray-600');
                    this.classList.remove('text-blue-600');
                    
                    // 添加展开动画
                    fullText.style.maxHeight = '0px';
                    fullText.style.opacity = '0';
                    fullText.style.transition = 'all 0.3s ease-out';
                    
                    setTimeout(() => {
                        fullText.style.maxHeight = '1000px';
                        fullText.style.opacity = '1';
                    }, 10);
                } else {
                    // 收起：显示预览文本
                    previewText.classList.remove('hidden');
                    fullText.classList.add('hidden');
                    
                    // 更新按钮样式
                    icon.style.transform = 'rotate(0deg)';
                    label.textContent = '展开完整内容';
                    this.classList.remove('text-gray-600');
                    this.classList.add('text-blue-600');
                }
            });
        });

        // 绑定图片预览事件
        document.querySelectorAll('.preview-img').forEach(img => {
            img.addEventListener('click', function (e) {
                // 如果按住Ctrl/Cmd键，则复制图片到剪贴板
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    console.log('Ctrl+点击图片，开始复制...');
                    const checksum = this.getAttribute('data-checksum');
                    console.log('图片checksum:', checksum);
                    
                    if (!checksum) {
                        console.error('未找到图片checksum属性');
                        showNotification('图片信息错误，无法复制', 'error');
                        return;
                    }
                    
                    // 查找复制按钮，使用更安全的选择器
                    const copyBtn = this.closest('.bg-white').querySelector('.copy-image-btn');
                    console.log('找到复制按钮:', copyBtn);
                    
                    if (copyBtn) {
                        copyImageToClipboard(checksum, copyBtn);
                    } else {
                        console.log('未找到复制按钮，使用直接复制');
                        // 如果找不到按钮，直接复制但不显示按钮状态
                        copyImageToClipboard(checksum, null);
                    }
                    return;
                }
                
                // 否则显示预览模态框
                const modal = document.getElementById('image-modal');
                const modalImg = document.getElementById('modal-image');
                const modalTitle = document.getElementById('modal-title');

                modalImg.src = this.getAttribute('data-src');
                modalTitle.textContent = this.getAttribute('data-filename');
                
                // 更新模态框的图片checksum
                if (window.updateModalImageChecksum) {
                    window.updateModalImageChecksum(this.getAttribute('data-checksum'));
                }

                modal.classList.remove('hidden');
            });
        });

        // 绑定收藏按钮事件
        document.querySelectorAll('.favorite-btn').forEach(button => {
            button.addEventListener('click', function () {
                const uuid = this.getAttribute('data-uuid');
                const isFavorite = this.classList.contains('text-yellow-500');

                // 这里应该调用后端API来更新收藏状态
                // 为了演示，先做前端状态切换
                if (isFavorite) {
                    this.classList.remove('text-yellow-500');
                    this.classList.add('text-gray-300');
                } else {
                    this.classList.remove('text-gray-300');
                    this.classList.add('text-yellow-500');
                }
            });
        });

        // 绑定复制图片按钮事件
        document.querySelectorAll('.copy-image-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const checksum = this.getAttribute('data-checksum');
                await copyImageToClipboard(checksum, this);
            });
        });
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 增强的文本格式化函数
    function formatTextDisplay(text) {
        if (!text) return '';
        
        // 先转义HTML
        let formatted = escapeHtml(text);
        
        // 检测并格式化URL
        formatted = formatted.replace(
            /(https?:\/\/[^\s]+)/g, 
            '<a href="$1" target="_blank" class="text-blue-600 hover:text-blue-800 underline" rel="noopener noreferrer">$1</a>'
        );
        
        // 检测邮箱地址
        formatted = formatted.replace(
            /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,
            '<a href="mailto:$1" class="text-blue-600 hover:text-blue-800 underline">$1</a>'
        );
        
        // 检测文件路径（Windows和Unix）
        formatted = formatted.replace(
            /([A-Za-z]:\\[^\\:*?"<>|]+|\/[^\\:*?"<>|\s]+)/g,
            '<span class="text-gray-600 bg-gray-100 px-1 py-0.5 rounded font-mono text-xs">$1</span>'
        );
        
        // 检测代码块（```code```）
        formatted = formatted.replace(
            /```([\s\S]*?)```/g,
            '<pre class="bg-gray-900 text-gray-100 p-3 rounded-lg overflow-x-auto my-2"><code>$1</code></pre>'
        );
        
        // 检测行内代码（`code`）
        formatted = formatted.replace(
            /`([^`]+)`/g,
            '<code class="bg-gray-200 text-gray-800 px-1 py-0.5 rounded text-sm font-mono">$1</code>'
        );
        
        return formatted;
    }

    // 防止XSS攻击的HTML转义函数
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 初始化分页事件
    function initPaginationEvents() {
        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentOffset > 0) {
                currentOffset -= PAGE_SIZE;
                loadHistory();
                // 滚动到顶部
                window.scrollTo(0, 0);
            }
        });
        document.getElementById('next-page').addEventListener('click', () => {
            if (currentOffset + PAGE_SIZE < totalRecords) {
                currentOffset += PAGE_SIZE;
                loadHistory();
                // 滚动到顶部
                window.scrollTo(0, 0);
            }
        });
    }

    // 更新分页控件状态
    function updatePaginationUI() {
        const totalPages = Math.ceil(totalRecords / PAGE_SIZE);
        const currentPage = Math.floor(currentOffset / PAGE_SIZE) + 1;

        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        document.getElementById('prev-page').disabled = currentOffset === 0;
        document.getElementById('next-page').disabled = currentOffset + PAGE_SIZE >= totalRecords;
        document.getElementById('pagination').classList.remove('hidden');
    }
</script>
{% endblock %}